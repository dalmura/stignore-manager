<div class="row">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="mb-0">File Browser</h2>
            <div class="text-muted small">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1">
                    <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                </svg>
                Browse and manage files across agents
            </div>
        </div>
    </div>
</div>
<div class="row" role="tabpanel">
    <div class="col">
        {% if items and items | length > 0 %}
        <div class="list-group" id="parentList" role="tablist">
            {% for i in items %}
            <a
                id="parent-item-{{ i.safe_id }}"
                class="d-flex justify-content-between align-items-center list-group-item list-group-item-action fade-in{% if i.has_insufficient_copies %} list-group-item-warning{% endif %}"
                data-bs-toggle="list"
                href="#list-sub1-{{ i.safe_id }}"
                role="tab"
                hx-post="/components/infopanel.html"
                hx-ext="json-enc"
                hx-include="#parent-item-{{ i.safe_id }} input"
                hx-target="#info-panel"
            >
                <div class="d-flex align-items-center">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="me-3 text-primary">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                    <span class="fw-medium">{{ i.name }}</span>
                </div>
                <span class="badge text-bg-primary rounded-pill">{{ i.items | length }}</span>
                <input type="hidden" name="item_path" value="">
                <input type="hidden" name="item_path" value="{{ i.id }}">
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-4">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" class="text-muted">
                    <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm6 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z" opacity="0.3"/>
                    <path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm0 13H4V8h16v11z"/>
                </svg>
            </div>
            <h4 class="text-muted mb-3">No Items Found</h4>
            <p class="text-muted mb-4">
                No categories or files were found from the configured agents.<br>
                This could be due to:
            </p>
            <ul class="list-unstyled text-muted mb-4">
                <li class="mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-warning">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" opacity="0.3"/>
                    </svg>
                    Agents are unreachable or timed out
                </li>
                <li class="mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-info">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    No categories configured on any agents
                </li>
                <li class="mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-2 text-secondary">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    All categories are empty
                </li>
            </ul>
            <div class="d-flex justify-content-center gap-3">
                <a href="/agents" class="btn btn-outline-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                    Check Agents Status
                </a>
                <button onclick="location.reload()" class="btn btn-outline-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>
        {% endif %}
    </div>
    <script>
        const triggerTabList = document.querySelectorAll('#parentList a');
        triggerTabList.forEach(triggerEl => {
            const tabTrigger = new bootstrap.Tab(triggerEl)

            triggerEl.addEventListener('click', event => {
                event.preventDefault();
                tabTrigger.show();

                // Update URL with selected element ID
                updateUrlWithSelection(triggerEl.id);

                const sub1ListRows = document.querySelectorAll("#sub1List div.tab-pane a");
                sub1ListRows.forEach(el => {
                    el.classList.remove("active");
                });

                const sub2List = document.querySelectorAll("#sub2List div.tab-pane");
                sub2List.forEach(el => {
                    el.classList.remove("active");
                    el.classList.remove("show");
                });

                const sub2ListRows = document.querySelectorAll("#sub2List div.tab-pane a");
                sub2ListRows.forEach(el => {
                    el.classList.remove("active");
                });
            });
        })
    </script>
    {% if items and items | length > 0 %}
    <div class="col">
        <div class="tab-content" id="sub1List" role="tablist">
            {% for i in items %}
            <div class="tab-pane" id="list-sub1-{{ i.safe_id }}" role="tabpanel">
                <div class="list-group" id="list-sub1-tabs-{{ i.safe_id }}" role="tablist"
                     hx-get="/components/subitems.html?parent_id={{ i.safe_id }}&parent_path={{ i.id }}"
                     hx-trigger="revealed"
                     hx-swap="innerHTML">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="text-muted small mt-2">Loading items...</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        // Event delegation is now handled in subitems.html for dynamically loaded content
    </script>
    <div class="col">
        <div class="tab-content" id="sub2List" role="tablist">
            <!-- Level 3 items will be loaded dynamically -->
        </div>
    </div>
    <script>
        // Event delegation is now handled in subsubitems.html for dynamically loaded content
    </script>
    {% endif %}
</div>

<script>
    // URL restoration logic
    document.addEventListener('DOMContentLoaded', function() {
        // Restore selection from URL after page loads
        setTimeout(() => {
            restoreSelectionFromUrl();
        }, 200);
    });

    // Also try calling immediately in case DOMContentLoaded already fired
    setTimeout(() => {
        if (typeof restoreSelectionFromUrl === 'function') {
            restoreSelectionFromUrl();
        }
    }, 500);
</script>