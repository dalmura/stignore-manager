{% for j in items %}
<a
        id="item-sub1-{{ parent_id }}-{{ j.safe_id }}"
        class="d-flex justify-content-between align-items-center list-group-item list-group-item-action fade-in{% if j.has_insufficient_copies %} list-group-item-warning{% endif %}"
        data-bs-toggle="list"
        href="#list-sub2-{{ j.safe_id }}"
        role="tab"
        hx-post="/components/infopanel.html"
        hx-ext="json-enc"
        hx-include="#item-sub1-{{ parent_id }}-{{ j.safe_id }} input"
        hx-target="#info-panel"
>
    <div class="d-flex align-items-center">
        {% if j.leaf %}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-3 text-secondary">
            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
        {% else %}
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="me-3 text-info">
            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
        </svg>
        {% endif %}
        <span>{{ j.name }}</span>
    </div>
    <span class="badge text-bg-primary rounded-pill">{{ j.items | length }}</span>
    <input type="hidden" name="item_path" value="">
    <input type="hidden" name="item_path" value="{{ parent_path }}">
    <input type="hidden" name="item_path" value="{{ j.id }}">
</a>
{% endfor %}

<script>
// Set up event delegation for dynamically loaded sub1 items
document.addEventListener('click', function(event) {
    const target = event.target.closest('a[id^="item-sub1-"]');
    if (target && target.getAttribute('data-bs-toggle') === 'list') {
        event.preventDefault();
        
        const tabTrigger = new bootstrap.Tab(target);
        tabTrigger.show();

        // Update URL with selected element ID
        if (typeof updateUrlWithSelection === 'function') {
            updateUrlWithSelection(target.id);
        }

        // Clear any existing sub2 content
        const sub2ListRows = document.querySelectorAll("#sub2List div.tab-pane a");
        sub2ListRows.forEach(el => {
            el.classList.remove("active");
        });

        // Load level 3 items if this is not a leaf
        const isLeaf = target.querySelector('svg').classList.contains('text-secondary');
        if (!isLeaf) {
            const sub2List = document.getElementById('sub2List');
            const tabPaneId = target.getAttribute('href').substring(1); // Remove # prefix
            
            // Create or update the sub2 tab pane
            let existingPane = document.getElementById(tabPaneId);
            if (!existingPane) {
                const newPane = document.createElement('div');
                newPane.className = 'tab-pane';
                newPane.id = tabPaneId;
                newPane.setAttribute('role', 'tabpanel');
                newPane.innerHTML = `
                    <div class="list-group" id="list-sub2-tabs-${tabPaneId.replace('list-sub2-', '')}" role="tablist"
                         hx-get="/components/subsubitems.html?parent_id=${tabPaneId.replace('list-sub2-', '')}&parent_path=${target.querySelector('input[name="item_path"]:nth-of-type(3)').value}"
                         hx-trigger="revealed"
                         hx-swap="innerHTML">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="text-muted small mt-2">Loading items...</div>
                        </div>
                    </div>
                `;
                sub2List.appendChild(newPane);
                
                // Trigger HTMX processing for the new element
                htmx.process(newPane);
            }
            
            // Show the tab pane
            const allPanes = sub2List.querySelectorAll('.tab-pane');
            allPanes.forEach(pane => {
                pane.classList.remove('active', 'show');
            });
            existingPane = document.getElementById(tabPaneId);
            existingPane.classList.add('active', 'show');
        }
    }
});
</script>